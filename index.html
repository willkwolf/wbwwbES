<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive WebGL Game">
    <meta name="keywords" content="game, webgl, interactive">
    <title>Game - Interactive Experience</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="css/game.css" as="style">
    <link rel="preload" href="js/lib/pixi.min.js" as="script">
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="css/game.css">
    
    <!-- Inline critical styles for better loading -->
    <style>
        /* Critical loading styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        
        .overlay.visible {
            display: flex;
        }
        
        #loading {
            background: #000;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Accessibility improvements */
        [dir="rtl"] {
            text-align: right;
        }
        
        /* Focus indicators for accessibility */
        button:focus,
        [tabindex]:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div class="overlay visible" id="loading" role="status" aria-label="Loading game">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div>Loading Game...</div>
        <div dir="rtl">در حال بارگذاری بازی...</div>
    </div>
    
    <!-- Main game container -->
    <main>
        <div id="stage" role="application" aria-label="Game canvas"></div>
        <div id="modal_shade" aria-hidden="true"></div>
    </main>
    
    <!-- Error/Warning overlays -->
    <div class="overlay" id="warning" role="alert" aria-live="assertive">
        <div dir="rtl">ای بابا!</div>
        <div dir="rtl">
            Your browser doesn't support WebGL.<br>
            Try a different browser or computer?<br>
            <br>
            مرورگر شما مرخص است! از یه مرورگر و یا کامپیوتر دیگه استفاده کنید!
        </div>
        <button onclick="GameLoader.retry()" style="margin-top: 20px; padding: 10px 20px;">
            Retry / تلاش مجدد
        </button>
    </div>
    
    <div class="overlay" id="paused" role="dialog" aria-label="Game paused">
        <div>Game Paused</div>
        <div dir="rtl">
            Click anywhere to resume<br>
            برای بازگشت رو یه جا رو کلیک کن!
        </div>
    </div>
    
    <!-- Scripts loaded asynchronously for better performance -->
    <script>
        // Global configuration
        window.GAME_CONFIG = {
            stats: false,
            shareText: 'همین الان یه بازی خیلی خفن رو بازی کردم',
            shareUrl: window.location.href
        };
        
        // Enhanced game loader with proper error handling
        class GameLoader {
            static scriptsToLoad = [
                // External Libraries (order matters)
                'js/lib/pixi.min.js',
                'js/lib/howler.js', 
                'js/lib/stats.min.js',
                'js/lib/tweenjs-0.6.2.min.js',
                'js/lib/helpers.js',
                
                // Text Strings
                'js/textStrings.js',
                
                // Core Engine Code
                'js/core/Game.js',
                'js/core/SceneManager.js', 
                'js/core/Scene.js',
                
                // Main Game Scene Code
                'js/game/World.js',
                'js/game/Camera.js',
                'js/game/Director.js',
                'js/game/Peep.js',
                'js/game/TV.js',
                'js/game/AnimationProp.js',
                'js/game/ScreenShake.js',
                'js/game/ScreenZoomOut.js',
                'js/game/Gore.js',
                'js/game/DeadBody.js',
                'js/game/Blood.js',
                
                // Peeps
                'js/peeps/NormalPeep.js',
                'js/peeps/CrazyPeep.js',
                'js/peeps/NervousPeep.js',
                'js/peeps/SnobbyPeep.js',
                'js/peeps/AngryPeep.js',
                'js/peeps/HatPeep.js',
                'js/peeps/LoverPeep.js',
                'js/peeps/ProtestAnim.js',
                'js/peeps/HelpingAnim.js',
                'js/peeps/HappyWeirdoPeep.js',
                'js/peeps/EvilHatPeep.js',
                'js/peeps/PanicPeep.js',
                'js/peeps/MurderPeep.js',
                
                // Misc Components
                'js/misc/Candlelight.js',
                'js/misc/LoversWatching.js',
                'js/misc/Cricket.js',
                'js/misc/Cursor.js',
                
                // Scenes
                'js/scenes/Scene_Preloader.js',
                'js/scenes/Scene_Quote.js',
                'js/scenes/Scene_Game.js',
                'js/scenes/Scene_Credits.js',
                'js/scenes/Scene_Post_Credits.js',
                'js/scenes/Scene_Post_Post_Credits.js',
                'js/scenes/Scene_EndPrototype.js',
                'js/scenes/Act_I.js',
                'js/scenes/Act_II.js',
                'js/scenes/Act_III.js',
                'js/scenes/Scene_Meta.js'
            ];
            
            static loadedScripts = 0;
            static totalScripts = this.scriptsToLoad.length;
            
            static init() {
                this.checkWebGLSupport();
                this.loadScripts();
            }
            
            static checkWebGLSupport() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (!gl) {
                        throw new Error('WebGL not supported');
                    }
                } catch (e) {
                    this.showError('webgl');
                    return false;
                }
                return true;
            }
            
            static async loadScripts() {
                try {
                    for (let i = 0; i < this.scriptsToLoad.length; i++) {
                        const scriptPath = this.scriptsToLoad[i];
                        await this.loadScript(scriptPath);
                        this.updateProgress(i + 1);
                        
                        // Special configurations after certain scripts
                        if (scriptPath.includes('tweenjs')) {
                            if (typeof Ticker !== 'undefined') {
                                Ticker.framerate = 60;
                                Ticker.paused = true;
                            }
                        }
                        
                        if (scriptPath.includes('tweenjs') && typeof createjs === 'undefined') {
                            window.createjs = window;
                        }
                    }
                    
                    this.initializeGame();
                    
                } catch (error) {
                    this.showError('loading', error);
                }
            }
            
            static loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = false; // Maintain execution order
                    
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error(`Failed to load: ${src}`));
                    
                    document.head.appendChild(script);
                });
            }
            
            static updateProgress(loaded) {
                const progress = Math.round((loaded / this.totalScripts) * 100);
                const loadingText = document.querySelector('#loading div:first-of-type');
                if (loadingText) {
                    loadingText.textContent = `Loading Game... ${progress}%`;
                }
            }
            
            static initializeGame() {
                try {
                    this.hideLoading();
                    
                    // Set game configuration
                    if (typeof Game !== 'undefined') {
                        Game.stats = window.GAME_CONFIG.stats;
                        Game.init();
                    } else {
                        throw new Error('Game object not found');
                    }
                    
                } catch (error) {
                    this.showError('init', error);
                }
            }
            
            static hideLoading() {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.classList.remove('visible');
                    setTimeout(() => {
                        loading.style.display = 'none';
                    }, 300);
                }
            }
            
            static showError(type, error = null) {
                this.hideLoading();
                
                const warning = document.getElementById('warning');
                if (warning) {
                    warning.classList.add('visible');
                }
                
                // Log error for debugging
                if (error) {
                    console.error(`Game loading error (${type}):`, error);
                }
            }
            
            static retry() {
                const warning = document.getElementById('warning');
                if (warning) {
                    warning.classList.remove('visible');
                }
                
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.classList.add('visible');
                }
                
                // Reset counters and try again
                this.loadedScripts = 0;
                setTimeout(() => this.init(), 1000);
            }
        }
        
        // Enhanced pause handling
        class GameStateManager {
            static init() {
                document.addEventListener('visibilitychange', this.handleVisibilityChange);
                window.addEventListener('blur', this.handleWindowBlur);
                window.addEventListener('focus', this.handleWindowFocus);
                
                // Click to resume functionality
                document.getElementById('paused')?.addEventListener('click', this.resumeGame);
            }
            
            static handleVisibilityChange() {
                if (document.hidden) {
                    this.pauseGame();
                } else {
                    this.resumeGame();
                }
            }
            
            static handleWindowBlur() {
                this.pauseGame();
            }
            
            static handleWindowFocus() {
                this.resumeGame();
            }
            
            static pauseGame() {
                if (typeof Game !== 'undefined' && Game.scene) {
                    const paused = document.getElementById('paused');
                    if (paused) {
                        paused.classList.add('visible');
                    }
                }
            }
            
            static resumeGame() {
                const paused = document.getElementById('paused');
                if (paused) {
                    paused.classList.remove('visible');
                }
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                GameLoader.init();
                GameStateManager.init();
            });
        } else {
            GameLoader.init();
            GameStateManager.init();
        }
    </script>
</body>
</html>